# JWT Security Implementation Guide

## Overview

The Security Clearance Tracker API is now secured with Spring Security and JWT authentication. All endpoints except public ones require a valid JWT token.

## Features

- **JWT Token Validation**: Validates JWT tokens on every request
- **Role-Based Access Control**: Supports USER and ADMIN roles
- **Subject Access Control**: Users can only access their own data (unless admin)
- **CORS Configuration**: Configured for frontend integration
- **Method-Level Security**: Uses `@PreAuthorize` annotations

## JWT Token Structure

The JWT token must contain these claims:
```json
{
  "sub": "username@example.com",
  "iss": "security-clearance-tracker-api",
  "iat": 1234567890,
  "exp": 1234567890,
  "subjectPersonaObjectId": "272ad768-ea92-4972-a8a5-2c270fdddd33",
  "roles": ["USER"]
}
```

## Getting Test Tokens (Mock Profile Only)

When running with `spring.profiles.active=mock`, you can generate test tokens:

### Generate User Token
```bash
curl http://localhost:9090/api/auth-test/token/user
```

### Generate Admin Token
```bash
curl http://localhost:9090/api/auth-test/token/admin
```

### Generate Custom Token
```bash
curl -X POST "http://localhost:9090/api/auth-test/token/custom?username=test@example.com&subjectPersonaObjectId=test-uuid&roles=USER"
```

## Using JWT Tokens

Include the JWT token in the Authorization header:

```bash
curl -H "Authorization: Bearer <your-jwt-token>" \
     http://localhost:9090/api/clearance/case-history
```

## API Endpoints

All endpoints under `/clearance/**` require authentication:

### Get Case History
```bash
GET /api/clearance/case-history?subjectPersonaObjectId=<uuid>
```
- If `subjectPersonaObjectId` not provided, uses JWT claim
- Users can only access their own data
- Admins can access any data

### Download PDF
```bash
GET /api/clearance/pdf-download/{caseId}
```

### Get Case Details and History
```bash
GET /api/clearance/case-details-history/{caseId}
```

## Public Endpoints (No Authentication Required)

- `/api/swagger-ui/**` - Swagger UI
- `/api/api-docs/**` - API Documentation
- `/api/health` - Health Check
- `/api/auth-test/**` - Test token generation (mock profile only)

## Error Responses

### 401 Unauthorized
```json
{
  "errorCode": 401,
  "errorMessage": "Unauthorized: Full authentication is required",
  "timestamp": "2025-08-01T09:30:00",
  "path": "/api/clearance/case-history"
}
```

### 403 Forbidden
```json
{
  "errorCode": 403,
  "errorMessage": "Access denied: Cannot access data for different subject",
  "timestamp": "2025-08-01T09:30:00",
  "path": "/api/clearance/case-history"
}
```

## Configuration

JWT settings in `application.properties`:
```properties
security.jwt.secret-key=mySecretKey123456789012345678901234567890
security.jwt.expiration-time=86400000
security.jwt.issuer=security-clearance-tracker-api
```

## Running the Application

```bash
# With JWT security enabled (default)
mvn spring-boot:run

# Specify port and profile
mvn spring-boot:run -Dserver.port=8080 -Dspring.profiles.active=mock
```

## Frontend Integration

Update your frontend to:
1. Get JWT token from authentication service
2. Include `Authorization: Bearer <token>` header in all API requests
3. Handle 401/403 responses appropriately

Example JavaScript:
```javascript
const token = 'your-jwt-token';
const response = await fetch('/api/clearance/case-history', {
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});
```

## Development Notes

- Test tokens are only available in mock profile
- In production, tokens should be generated by your authentication service
- The secret key should be stored securely (environment variable)
- Token expiration is set to 24 hours by default